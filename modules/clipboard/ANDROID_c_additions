/* clipboard -*-C-*- */

jstring jstr;
const char *str = NULL;

int android_clipboard_copy(char *str) {
  JNIEnv *env = GetJNIEnv();
  jstring jstr = (*env)->NewStringUTF(env,str);
  static jmethodID method = 0;
  if(env) {
    if(!method) {
      method = (*env)->GetMethodID(env, main_class, "setClipboardContent", "(Ljava/lang/String;)I");
      if(!method) {
        JNI_forward_exception_to_gambit(env);
        return 0;
      }
    }
    return (*env)->CallIntMethod(env, globalObj, method, jstr);
  }
  return 0;
}

const char *android_clipboard_paste(){
  JNIEnv *env = GetJNIEnv();
  static jmethodID method = 0;
  if(!main_class) (*env)->FatalError(env, "android_clipboard_paste: no main_class");
  if(env) {
    if(!method) {
      method = (*env)->GetMethodID(env, main_class, "getClipboardContent", "()Ljava/lang/String;");
      if(!method) {
        JNI_forward_exception_to_gambit(env);
        return "";
      }
      jstr = (jstring) (*env)->CallObjectMethod(env, globalObj, method, jstr);
      str  = (*env)->GetStringUTFChars(env, jstr, 0);
    }
    // (*env)->ReleaseStringUTFChars(env, jstr, str);
    return str;
  }
  return "";
}

void android_clipboard_release() {
  if (str) {
    JNIEnv *env = GetJNIEnv();
    (*env)->ReleaseStringUTFChars(env, jstr, str);
    str = NULL;
  }
  return;
}

int android_clipboard_clear(){
  return 0;
}

int android_clipboard_hascontent() {
  JNIEnv *env = GetJNIEnv();
  static jmethodID method = 0;
  if(env) {
    if(!method) {
    jmethodID method = (*env)->GetMethodID(env, main_class, "checkClipboardContent", "()I");
    if(!method) {
      JNI_forward_exception_to_gambit(env);
      return 0;
    }
    return (*env)->CallIntMethod(env, globalObj, method);
    }
  }
  return 0;
}
